<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Nerdcore Museum 2 Player</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- jsmediatags for ID3 cover art -->
  <script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.5/dist/jsmediatags.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header, footer { padding: 1em; background: #222; color: #fff; text-align: center; }
    main {
      flex: 1;
      display: flex;
      flex-direction: row;
      overflow: hidden;
    }
    /* PC: サイドにリスト、中央にプレイヤー */
    #folders { width: 200px; overflow-y: auto; border-right: 1px solid #ccc; }
    #player {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1em;
    }
    #cover { max-width: 80%; max-height: 300px; margin-bottom: 1em; }
    #controls button { margin: 0 .5em; }

    /* スマホ: 縦レイアウト */
    @media(max-width: 600px) {
      main { flex-direction: column; }
      #folders { width: 100%; height: 120px; display: flex; overflow-x: auto; border-right: none; border-bottom: 1px solid #ccc; }
      #folders button { flex: none; margin: .5em; }
      #cover { max-width: 100%; max-height: 200px; }
    }
  </style>
</head>
<body>
  <header><h1>Nerdcore Museum 2 Player</h1></header>
  <main>
    <nav id="folders"><!-- 動的にフォルダボタンを追加 --></nav>
    <section id="player">
      <img id="cover" src="" alt="Album Art">
      <div id="track-info">Loading...</div>
      <audio id="audio"></audio>
      <div id="controls">
        <button id="prev">⏮️</button>
        <button id="rew">⏪ 10s</button>
        <button id="play">▶️</button>
        <button id="ff">10s ⏩</button>
        <button id="next">⏭️</button>
        <button id="loop">🔁 Off</button>
      </div>
      <input type="range" id="seek" value="0" min="0" max="100">
    </section>
  </main>
  <footer>
    <button id="next-folder">Next Folder →</button>
  </footer>

  <script>
  (async ()=>{
    const owner = 'Emon2358',
          repo  = 'nerdcore-Museum-2',
          pathAlbums = 'albums';
    const foldersEl = document.getElementById('folders');
    const audio  = document.getElementById('audio');
    const cover  = document.getElementById('cover');
    const info   = document.getElementById('track-info');
    const btns   = {
      prev: document.getElementById('prev'),
      rew:  document.getElementById('rew'),
      play: document.getElementById('play'),
      ff:   document.getElementById('ff'),
      next: document.getElementById('next'),
      loop: document.getElementById('loop'),
      seek: document.getElementById('seek'),
      nextFolder: document.getElementById('next-folder'),
    };

    let folders = [], curFolderIndex = 0;
    let tracks = [], curTrack = 0;

    // GitHub Contents API でフォルダ一覧取得
    async function loadFolders(){
      const res = await fetch(
        `https://api.github.com/repos/${owner}/${repo}/contents/${pathAlbums}`
      );
      const items = await res.json();
      folders = items.filter(i=> i.type==='dir' );
      foldersEl.innerHTML = '';
      folders.forEach((f,i)=>{
        const b = document.createElement('button');
        b.textContent = decodeURIComponent(f.name);
        b.onclick = ()=>selectFolder(i);
        foldersEl.appendChild(b);
      });
      if(folders.length) selectFolder(0);
    }

    // フォルダ選択
    async function selectFolder(idx){
      curFolderIndex = idx;
      curTrack = 0;
      const folder = folders[idx];
      const res = await fetch(folder.url);
      const items = await res.json();
      tracks = items.filter(i=> i.name.toLowerCase().endsWith('.mp3'))
                    .map(i=> ({name: decodeURIComponent(i.name), url: i.download_url}));
      loadTrack(0);
    }

    // トラックロード
    function loadTrack(idx){
      if(!tracks[idx]) return;
      curTrack = idx;
      audio.src = tracks[idx].url;
      info.textContent = `${tracks[idx].name}`;
      loadCover(tracks[idx].url);
      updateMediaSession();
      updateLoopButton();
      audio.play();
    }

    // ID3 cover 読み込み
    function loadCover(url){
      cover.src = '';  // clear
      window.jsmediatags.read(url, {
        onSuccess: tag => {
          const data = tag.tags.picture;
          if(data){
            const blob = new Blob([new Uint8Array(data.data)], {type: data.format});
            cover.src = URL.createObjectURL(blob);
          }
        },
        onError: _=> { cover.src = ''; }
      });
    }

    // Media Session API
    function updateMediaSession(){
      if('mediaSession' in navigator){
        navigator.mediaSession.metadata = new MediaMetadata({
          title: tracks[curTrack].name,
          artwork: cover.src ? [{src: cover.src, sizes:'500x500', type:'image/png'}] : []
        });
      }
    }

    // コントロール
    btns.play.onclick = ()=> audio.paused ? audio.play() : audio.pause();
    btns.prev.onclick = ()=> loadTrack((curTrack-1+tracks.length)%tracks.length);
    btns.next.onclick = ()=> loadTrack((curTrack+1)%tracks.length);
    btns.rew.onclick  = ()=> audio.currentTime = Math.max(0, audio.currentTime-10);
    btns.ff.onclick   = ()=> audio.currentTime = Math.min(audio.duration||0, audio.currentTime+10);
    btns.loop.onclick = ()=>{
      audio.loop = !audio.loop;
      updateLoopButton();
    };
    function updateLoopButton(){
      btns.loop.textContent = audio.loop ? '🔁 On' : '🔁 Off';
    }
    audio.onplay  = ()=> btns.play.textContent = '⏸️';
    audio.onpause = ()=> btns.play.textContent = '▶️';
    audio.ontimeupdate = ()=>{
      if(audio.duration){
        btns.seek.value = (audio.currentTime/audio.duration)*100;
      }
    };
    btns.seek.oninput = e=>{
      if(audio.duration){
        audio.currentTime = audio.duration*(e.target.value/100);
      }
    };

    // フォルダ移動
    btns.nextFolder.onclick = ()=>{
      selectFolder((curFolderIndex+1)%folders.length);
    };

    // 初期化
    await loadFolders();
  })();
  </script>
</body>
</html>
