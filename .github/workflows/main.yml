name: Download and Upload Audio Albums via GigaFile

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: 'Root albums URL (with trailing slash). çœç•¥å¯'
        required: false
        default: 'https://archive.org/download/Sharpnel-Discography/SHARPNELSOUND/albums/'
      targets:
        description: |
          ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯¾è±¡ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§æŒ‡å®šã€‚
          - ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªIDï¼ˆdefaults to base_url + ID/ï¼‰
          - ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«URLï¼ˆ.mp3, archive.orgãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªURL, Bandcamp URL ãªã©ï¼‰
        required: false
      folder_name:
        description: 'albums/ ä»¥ä¸‹ã«ä½œæˆã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€åã‚’æŒ‡å®šã€‚çœç•¥æ™‚ã¯è‡ªå‹•ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€'
        required: false

jobs:
  download-and-upload:
    runs-on: ubuntu-latest
    steps:
      # 1) ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆLFS ã¯ä½¿ã„ã¾ã›ã‚“ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2) å¿…è¦ãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget jq python3-pip ffmpeg zip
          pip3 install --user yt-dlp gigafile

      # 3) å…¥åŠ›å€¤ã‚’ç’°å¢ƒå¤‰æ•°ã«ã‚»ãƒƒãƒˆ
      - name: Set inputs
        run: |
          echo "BASE_URL=${{ github.event.inputs.base_url }}" >> $GITHUB_ENV
          echo "TARGETS=${{ github.event.inputs.targets }}" >> $GITHUB_ENV
          echo "FOLDER_NAME=${{ github.event.inputs.folder_name }}" >> $GITHUB_ENV

      # 4) identifiers.json ã‚’ä½œæˆï¼ˆTARGETS æœªæŒ‡å®šæ™‚ã®ã¿ï¼‰
      - name: Fetch list of identifiers
        if: ${{ !github.event.inputs.targets }}
        id: list
        run: |
          raw_ids=$(wget --spider -r -l1 -nd -np "$BASE_URL" 2>&1 \
            | grep '^--' | awk '{print $3}' \
            | grep -oP '[^/]+(?=/)' | sort -u)
          printf '%b\n' "${raw_ids[@]}" | jq -R . | jq -s . > identifiers.json

      # 5) ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
      - name: Download audio files
        run: |
          set -euo pipefail
          mkdir -p downloads
          ACCEPT="*.mp3,*.flac,*.ogg,*.m4a,*.wav,*.aac"

          if [ -n "$TARGETS" ]; then
            IFS=',' read -ra items <<< "$TARGETS"
          else
            mapfile -t items < <(jq -r '.[]' identifiers.json)
          fi

          for raw in "${items[@]}"; do
            t="${raw//\"/}"
            subdir="${FOLDER_NAME:-${t%%.*}}"
            mkdir -p "downloads/$subdir"
            echo "â†’ Processing [$t] â†’ downloads/$subdir/"
            if [[ "$t" =~ \.(mp3|flac|ogg|m4a|wav|aac)$ ]]; then
              wget --content-disposition -q -P "downloads/$subdir" "$t"
            elif [[ "$t" =~ archive\.org/download ]]; then
              wget -r -np -nd -A "$ACCEPT" -P "downloads/$subdir" "$t"
            elif [[ "$t" =~ bandcamp\.com ]]; then
              ~/.local/bin/yt-dlp -x --audio-format mp3 \
                -o "downloads/$subdir/%(title)s.%(ext)s" "$t"
            else
              url="${BASE_URL%/}/$t/"
              if wget --spider --quiet "$url"; then
                wget -r -np -nd -A "$ACCEPT" -P "downloads/$subdir" "$url"
              else
                echo "âš ï¸ $url ãŒå­˜åœ¨ã—ãªã„"
              fi
            fi
          done

      # 6) downloads â†’ albums/ ã¸ç§»å‹•ï¼ˆãƒ•ã‚©ãƒ«ãƒ€åã‚’ä¿æŒï¼‰
      - name: Move downloads to albums/
        run: |
          mkdir -p albums
          for d in downloads/*; do
            name=$(basename "$d")
            mkdir -p "albums/$name"
            shopt -s nullglob
            moved=false
            for ext in mp3 flac ogg m4a wav aac; do
              for f in "$d"/*."$ext"; do
                mv "$f" "albums/$name/" && moved=true
              done
            done
            if $moved; then
              echo "âœ” Moved albums/$name"
            else
              echo "âš  No audio files in $d"
            fi
          done

      # 7) albums/ ã‚’ ZIP åŒ–
      - name: Zip albums directory
        run: |
          zip -r albums.zip albums

      # 8) GigaFileä¾¿ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€URL ã‚’å–å¾—
      - name: Upload albums.zip to GigaFile
        id: upload
        run: |
          UPLOAD_URL=$(gfile upload albums.zip | tail -n1)
          echo "UPLOAD_URL=$UPLOAD_URL" >> $GITHUB_ENV

      # 9) çµæœ URL ã‚’å‡ºåŠ›
      - name: Show GigaFile URL
        run: |
          echo "ğŸ‰ Your download link: ${{ env.UPLOAD_URL }}"
