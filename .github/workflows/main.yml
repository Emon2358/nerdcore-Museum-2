name: Download and Commit MP3 Albums

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: 'Root albums URL (with trailing slash)'
        required: true
        default: 'https://archive.org/download/Sharpnel-Discography/SHARPNELSOUND/albums/'

jobs:
  download-and-upload:
    runs-on: ubuntu-latest

    steps:
      # 1) フル履歴チェックアウト
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true
          fetch-depth: 0

      # 2) Git HTTP 設定強化
      - name: Configure Git HTTP settings
        run: |
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999

      # 3) Git LFS セットアップ
      - name: Install Git LFS and track MP3
        run: |
          sudo apt-get update
          sudo apt-get install -y git-lfs
          git lfs install --local
          echo "*.mp3 filter=lfs diff=lfs merge=lfs -text" >> .gitattributes
          git add .gitattributes
          git commit -m "chore: track MP3 via Git LFS" || echo "No changes to .gitattributes"

      # 4) wget, jq のインストール
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget jq

      # 5) BASE_URL 設定
      - name: Set base URL
        run: echo "BASE_URL=${{ github.event.inputs.base_url }}" >> $GITHUB_ENV

      # 6) ディレクトリ一覧取得＆デコード
      - name: Fetch list of identifiers
        id: list
        run: |
          raw_ids=$(wget --spider -r -l1 -nd -np "$BASE_URL" 2>&1 \
            | grep '^--' \
            | awk '{print $3}' \
            | grep -oP '[^/]+(?=/$)' \
            | sort -u)

          decoded_ids=()
          for id in $raw_ids; do
            decoded=$(printf '%b' "${id//%/\\x}")
            decoded_ids+=("$decoded")
          done

          json=$(printf '%s\n' "${decoded_ids[@]}" | jq -R . | jq -s .)
          echo "IDENTIFIERS<<EOF" >> $GITHUB_OUTPUT
          echo "$json"               >> $GITHUB_OUTPUT
          echo "EOF"                 >> $GITHUB_OUTPUT

      # 7) MP3 を安全にダウンロード
      - name: Download MP3 files for each identifier
        run: |
          mkdir -p downloads
          # JSON 配列をパイプで読み込んで1行ずつ処理
          echo "${{ steps.list.outputs.IDENTIFIERS }}" \
            | jq -r '.[]' \
            | while IFS= read -r id; do
                url="${BASE_URL}${id}/"
                echo "→ Downloading [$id] from $url"
                if wget --spider --quiet "$url"; then
                  mkdir -p "downloads/$id"
                  wget -r -np -nd -A '*.mp3' -P "downloads/$id" "$url"
                else
                  echo "⚠️ $url が存在しないかアクセス不可"
                fi
              done

      # 8) albums/ に移動
      - name: Copy into repo
        run: |
          mkdir -p albums
          for d in downloads/*; do
            dir_name=$(basename "$d")
            mkdir -p "albums/${dir_name}"
            mv "$d"/*.mp3 "albums/${dir_name}/" \
              || echo "⚠️ $dir_name に MP3 がありませんでした"
          done

      # 9) Commit & Push
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add albums/
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add MP3s for new albums ($(date +'%Y-%m-%d'))"
            git push
          fi
