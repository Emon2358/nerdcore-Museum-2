name: Download and Commit Audio Albums

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: 'Root albums URL (with trailing slash). 省略可'
        required: false
        default: 'https://archive.org/download/Sharpnel-Discography/SHARPNELSOUND/albums/'
      targets:
        description: |
          ダウンロード対象をカンマ区切りで指定。
          - ディレクトリID（defaults to base_url + ID/）
          - 直接ファイルURL（.mp3, archive.orgディレクトリURL, Bandcamp URL など）
          省略時は base_url 以下すべてのディレクトリを取得して処理
        required: false
      folder_name:
        description: |
          albums/ 以下に作成するフォルダ名を指定。
          省略時は各ID やファイルに応じたサブフォルダを自動作成
        required: false

jobs:
  download-and-upload:
    runs-on: ubuntu-latest

    steps:
      # 1) リポジトリをフル履歴でチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true
          fetch-depth: 0

      # 2) Git の HTTP 設定を拡張
      - name: Configure Git HTTP settings
        run: |
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999

      # 3) Git LFS をセットアップして主要なオーディオ形式を LFS 管理
      - name: Install Git LFS and track audio files
        run: |
          sudo apt-get update
          sudo apt-get install -y git-lfs
          git lfs install --local
          for ext in mp3 flac ogg m4a wav aac; do
            echo "*.${ext} filter=lfs diff=lfs merge=lfs -text" >> .gitattributes
          done
          git add .gitattributes
          git commit -m "chore: track audio files via Git LFS" || echo "No changes to .gitattributes"

      # 4) wget, jq, yt-dlp, ffmpeg のインストール
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget jq python3-pip ffmpeg
          pip3 install --user yt-dlp

      # 5) 入力値を環境変数に設定
      - name: Set inputs as env vars
        run: |
          echo "BASE_URL=${{ github.event.inputs.base_url }}" >> $GITHUB_ENV
          echo "TARGETS=${{ github.event.inputs.targets }}" >> $GITHUB_ENV
          echo "FOLDER_NAME=${{ github.event.inputs.folder_name }}" >> $GITHUB_ENV

      # 6) identifiers.json を作る（targets未指定時のみ）
      - name: Fetch list of identifiers (if no TARGETS)
        if: ${{ !github.event.inputs.targets }}
        id: list
        run: |
          raw_ids=$(wget --spider -r -l1 -nd -np "$BASE_URL" 2>&1 \
            | grep '^--' \
            | awk '{print $3}' \
            | grep -oP '[^/]+(?=/)' \
            | sort -u)

          decoded_ids=()
          for id in $raw_ids; do
            decoded=$(printf '%b' "${id//%/\\x}")
            decoded_ids+=("$decoded")
          done

          printf '%s\n' "${decoded_ids[@]}" | jq -R . | jq -s . > identifiers.json

      # 7) オーディオファイルダウンロード処理
      - name: Download audio files
        run: |
          set -euo pipefail
          mkdir -p downloads
          ACCEPT_LIST="*.mp3,*.flac,*.ogg,*.m4a,*.wav,*.aac"

          if [ -n "$TARGETS" ]; then
            IFS=',' read -ra items <<< "$TARGETS"
          else
            mapfile -t items < <(jq -r '.[]' identifiers.json)
          fi

          for item in "${items[@]}"; do
            target="$item"
            target="${target#"${target%%[![:space:]]*}"}"
            target="${target%"${target##*[![:space:]]}"}"
            target="${target%\"}"
            target="${target#\"}"
            target="${target%\'}"
            target="${target#\'}"

            if [ -n "$FOLDER_NAME" ]; then
              subdir="$FOLDER_NAME"
            else
              if [[ "$target" =~ ^https?:// ]]; then
                subdir=$(basename "${target%/}")
                subdir="${subdir%%.*}"
              else
                subdir="$target"
              fi
            fi

            echo "→ Processing [$target] → albums/$subdir/"
            mkdir -p "downloads/$subdir"

            if [[ "$target" =~ \.(mp3|flac|ogg|m4a|wav|aac)$ ]]; then
              wget --content-disposition -q -P "downloads/$subdir" "$target"
            elif [[ "$target" =~ archive\.org/download ]]; then
              wget -r -np -nd -A "$ACCEPT_LIST" -P "downloads/$subdir" "$target"
            elif [[ "$target" =~ bandcamp\.com ]]; then
              ~/.local/bin/yt-dlp -x --audio-format mp3 \
                -o "downloads/$subdir/%(title)s.%(ext)s" "$target"
            else
              url="${BASE_URL%/}/$target/"
              if wget --spider --quiet "$url"; then
                wget -r -np -nd -A "$ACCEPT_LIST" -P "downloads/$subdir" "$url"
              else
                echo "⚠️ $url が存在しないかアクセス不可"
              fi
            fi
          done

      # 8) albums/ にコピー
      - name: Copy into repo
        run: |
          set -euo pipefail
          shopt -s nullglob
          mkdir -p albums
          AUDIO_EXTS=(mp3 flac ogg m4a wav aac)

          for d in downloads/*; do
            dir_name=$(basename "$d")
            mkdir -p "albums/${dir_name}"
            moved=false

            for ext in "${AUDIO_EXTS[@]}"; do
              for file in "$d"/*."$ext"; do
                mv "$file" "albums/${dir_name}/"
                moved=true
              done
            done

            if [ "$moved" = true ]; then
              echo "✔️ albums/${dir_name}/ にファイルを移動"
            else
              echo "⚠️ $d に対応ファイルがありませんでした"
            fi
          done

      # 9) コミット＆プッシュ（リモートを先にフェッチ＆リベース）
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # リモートの最新を取得してリベース
          git fetch origin
          # 現在のブランチ名を取得
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          git checkout "$BRANCH"
          git pull --rebase origin "$BRANCH" || true

          git add albums/
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add audio files for new albums ($(date +'%Y-%m-%d'))"
            git pull --rebase origin "$BRANCH" || true
            git push
          fi
