name: Download and Release Audio Albums

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: 'Root albums URL (with trailing slash).ÁúÅÁï•ÂèØ'
        required: false
        default: 'https://archive.org/download/Sharpnel-Discography/SHARPNELSOUND/albums/'
      targets:
        description: |
          „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂØæË±°„Çí„Ç´„É≥„ÉûÂå∫Âàá„Çä„ÅßÊåáÂÆö„ÄÇ
          - „Éá„Ç£„É¨„ÇØ„Éà„É™ID
          - Áõ¥Êé•„Éï„Ç°„Ç§„É´URL
        required: false
      folder_name:
        description: 'albums/‰ª•‰∏ã„Å´‰ΩúÊàê„Åô„Çã„Éï„Ç©„É´„ÉÄÂêç„ÄÇÁúÅÁï•ÊôÇ„ÅØID„Åî„Å®„ÅÆ„Éï„Ç©„É´„ÉÄ'
        required: false

jobs:
  download-and-release:
    runs-on: ubuntu-latest
    steps:
      # 1) Checkout so that .git exists for gh release
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2) ÂøÖË¶Å„ÉÑ„Éº„É´„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget jq python3-pip ffmpeg zip gh
          pip3 install --user yt-dlp

      # 3) ÂÖ•Âäõ„ÇíÁí∞Â¢ÉÂ§âÊï∞„Å´„Çª„ÉÉ„Éà
      - name: Set inputs
        run: |
          echo "BASE_URL=${{ github.event.inputs.base_url }}" >> $GITHUB_ENV
          echo "TARGETS=${{ github.event.inputs.targets }}" >> $GITHUB_ENV
          echo "FOLDER_NAME=${{ github.event.inputs.folder_name }}" >> $GITHUB_ENV

      # 4) identifiers.json ‰ΩúÊàêÔºàTARGETS Êú™ÊåáÂÆöÊôÇ„ÅÆ„ÅøÔºâ
      - name: Fetch identifiers
        if: ${{ !github.event.inputs.targets }}
        run: |
          raw_ids=$(wget --spider -r -l1 -nd -np "$BASE_URL" 2>&1 \
            | grep '^--' | awk '{print $3}' \
            | grep -oP '[^/]+(?=/)' | sort -u)
          printf '%b\n' "${raw_ids[@]}" | jq -R . | jq -s . > identifiers.json

      # 5) „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÔºàÂ§±Êïó„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºâ
      - name: Download audio files (skip failures)
        run: |
          mkdir -p downloads
          AUDIO_EXTS=(mp3 flac ogg m4a wav aac opus wma)
          ACCEPT=$(printf ",*.%s" "${AUDIO_EXTS[@]}") && ACCEPT="${ACCEPT:1}"

          if [ -n "$TARGETS" ]; then
            IFS=',' read -ra items <<< "$TARGETS"
          else
            mapfile -t items < <(jq -r '.[]' identifiers.json)
          fi

          for raw in "${items[@]}"; do
            t="${raw//\"/}"
            subdir="${FOLDER_NAME:-${t%%.*}}"
            mkdir -p "downloads/$subdir"
            echo "‚Üí Processing [$t]"
            if [[ "$t" =~ \.(mp3|flac|ogg|m4a|wav|aac|opus|wma)$ ]]; then
              wget -c -P "downloads/$subdir" "$t" || echo "‚ö† Skip $t"
            elif [[ "$t" =~ archive\.org/download ]]; then
              wget -c -r -np -nd -A "$ACCEPT" -P "downloads/$subdir" "$t" || echo "‚ö† Skip $t"
            elif [[ "$t" =~ bandcamp\.com ]]; then
              yt-dlp -x --audio-format mp3 -o "downloads/$subdir/%(title)s.%(ext)s" "$t" || echo "‚ö† Skip $t"
            else
              url="${BASE_URL%/}/$t/"
              wget -c -r -np -nd -A "$ACCEPT" -P "downloads/$subdir" "$url" || echo "‚ö† Skip $url"
            fi
          done

      # 6) downloads ‚Üí albums „Å´Êï¥ÁêÜ
      - name: Organize into albums/
        run: |
          mkdir -p albums
          AUDIO_EXTS=(mp3 flac ogg m4a wav aac opus wma)
          for d in downloads/*; do
            name=$(basename "$d")
            mkdir -p "albums/$name"
            shopt -s nullglob
            for ext in "${AUDIO_EXTS[@]}"; do
              mv -u "$d"/*."$ext" "albums/$name/" || true
            done
          done

      # 7) ZIPÂåñ
      - name: Zip albums
        run: zip -r albums.zip albums

      # 8) Release „Çø„Ç∞ÁîüÊàê
      - name: Generate release tag
        run: echo "RELEASE_TAG=audio-$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV

      # 9) GitHub CLI Ë™çË®º
      - name: Authenticate gh CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      # 10) Release ‰ΩúÊàêÔºÜZIP„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÔºàÂ§±Êïó„ÅØ„É™„Éà„É©„Ç§Ôºâ
      - name: Create Release and upload asset
        run: |
          # create or update release
          if gh release view "$RELEASE_TAG" >/dev/null 2>&1; then
            echo "Release $RELEASE_TAG exists, updating asset..."
          else
            gh release create "$RELEASE_TAG" --title "Audio Albums $RELEASE_TAG" --notes "Generated on $(date +'%Y-%m-%d %H:%M:%S')"
          fi
          # upload with retries
          for i in {1..5}; do
            gh release upload "$RELEASE_TAG" albums.zip --clobber && break
            echo "Retry upload ($i/5)..."
            sleep 5
          done

      # 11) ÂÆå‰∫Ü„É≠„Ç∞
      - name: Done
        run: echo "üéâ albums.zip is available in release $RELEASE_TAG"
